<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Lots of meshes Example</title>
        <style></style>
    </head>
    <body>
        <div class="container">
            <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
        </div>
        <script src="vizgl-wrapper-umd.js"></script>

        <script>
            const vizgl = window.vizgl;

            function loadJSON(url) {
                return fetch(url).then(response => response.json());
            }

            function hexToRgb(hex) {
                if (hex.toLowerCase() === '#ffffff') {
                    return [0.5, 0.5, 0.5];
                }

                // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
                var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                    return r + r + g + g + b + b;
                });

                var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? [
                    parseInt(result[1], 16),
                    parseInt(result[2], 16),
                    parseInt(result[3], 16)
                ] : null;
            }

            function flattenArrayToTypedArray(input, TypedArray) {
                const width = input[0].length;
                const out = new TypedArray(input.length * width);

                input.forEach((v, i) => {
                    for (let j = 0; j < width; j++) {
                        out[i * width + j] = v[j];
                    }
                });
                return out;
            }

            Module = {
                canvas: document.getElementById('canvas'),

                onRuntimeInitialized: () => {
                    const module = new vizgl.ModuleWrapper(Module);
                    const geometryApi = new vizgl.GeometryApi(module);
                    const colorMapApi = new vizgl.ColorMapApi(module);
                    const mappingApi = new vizgl.MappingApi(module);
                    const modelApi = new vizgl.ModelApi(module);

                    const loader = loadJSON('res/lots-of-meshes.json');

                    Promise.all([loader]).then(loadedData => {
                        const [meshes] = loadedData
                        console.log({ loadedData });

                        for (let i = 0; i < 100; i++) {
                            const { vertices, triangles, color: { value: hexColor } } = meshes[i];
                            const verts = flattenArrayToTypedArray(vertices, Float32Array);
                            const tris = flattenArrayToTypedArray(triangles, Uint32Array);
                            const geometryId = geometryApi.createMesh2(verts, tris);
                            const mappingId = mappingApi.createStaticMapping(hexToRgb(hexColor));
                            const modelId = modelApi.createModel(geometryId, mappingId);
                            console.log({ modelId, geometryId, mappingId });
                        }
                    });
                },
            };
        </script>

        <script async type="text/javascript" src="vizgl.js"></script>
    </body>
</html>
