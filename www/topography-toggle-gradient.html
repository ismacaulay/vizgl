<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Topography Example</title>
        <style></style>
    </head>
    <body>
        <div class="container">
            <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
        </div>
        <script src="vizgl-wrapper-umd.js"></script>

        <script>
            const vizgl = window.vizgl;
            let mappingApi;

            function loadJSON(url) {
                return fetch(url).then(response => response.json());
            }

            function toggleColormaps(mappingId, colormaps) {
                const timout = 3000;

                let index = 0;
                const toggleColorMap = () => {
                    index = (index + 1) % colormaps.length;
                    mappingApi.setContinuousMappingGradient(mappingId, colormaps[index]);
                    setTimeout(toggleColorMap, timout);
                };
                setTimeout(toggleColorMap, timout);
            }

            Module = {
                canvas: document.getElementById('canvas'),

                onRuntimeInitialized: () => {
                    const module = new vizgl.ModuleWrapper(Module);
                    const geometryApi = new vizgl.GeometryApi(module);
                    const colorMapApi = new vizgl.ColorMapApi(module);
                    mappingApi = new vizgl.MappingApi(module);
                    const modelApi = new vizgl.ModelApi(module);

                    const geometryLoader = loadJSON('res/geometry/topography.json');
                    const dataLoader = loadJSON('res/data/topography.json');
                    const crazyColorMapLoader = loadJSON('res/colormaps/joes-crazy-colors.json');
                    const viridisColorMapLoader = loadJSON('res/colormaps/viridis.json');

                    Promise.all([
                        geometryLoader,
                        dataLoader,
                        crazyColorMapLoader,
                        viridisColorMapLoader,
                    ]).then(loadedData => {
                        const [geometry, data, crazyColorMap, viridisColorMap] = loadedData;
                        // console.log({ loadedData });

                        const { vertices, triangles } = geometry;
                        const { values } = data;

                        const transformedData = triangles.map(vertexIdx => {
                            return values[vertexIdx];
                        });
                        // console.log({ transformedData });
                        const geometryId = geometryApi.createMesh2(vertices, triangles);
                        const crazyId = colorMapApi.createColorMap(crazyColorMap.colors);
                        const viridisId = colorMapApi.createColorMap(viridisColorMap.colors);
                        const mappingId = mappingApi.createContinuosMapping(
                            transformedData,
                            crazyId,
                        );

                        const modelId = modelApi.createModel(geometryId, mappingId);
                        toggleColormaps(mappingId, [crazyId, viridisId]);
                    });
                },
            };
        </script>

        <script async type="text/javascript" src="vizgl.js"></script>
    </body>
</html>
